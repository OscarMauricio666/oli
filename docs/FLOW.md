# Flujo de Información - oli

Este documento detalla cómo fluye la información a través del sistema oli.

---

## 1. Flujo Principal de Ejecución

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              USUARIO                                        │
└─────────────────────────────────────┬───────────────────────────────────────┘
                                      │
                                      │ $ oli "explica este código"
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            ENTRADA (main.go)                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐       │
│   │  os.Args        │     │  Modo Directo   │     │ Modo Interactivo│       │
│   │  (argumentos)   │────►│  (una pregunta) │ o   │ (loop continuo) │       │
│   └─────────────────┘     └────────┬────────┘     └────────┬────────┘       │
│                                    │                       │                │
│                                    └───────────┬───────────┘                │
│                                                │                            │
└────────────────────────────────────────────────┼────────────────────────────┘
                                                 │
                                                 ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          ORQUESTADOR (app.go)                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   app.Run(ctx, task)                                                        │
│        │                                                                    │
│        ├──────────────────────────────────────────────────────────────┐     │
│        │                                                              │     │
│        ▼                                                              │     │
│   ┌─────────────────────────────────────────────────────────────┐     │     │
│   │              FASE 1: RECOPILACIÓN DE CONTEXTO               │     │     │
│   └─────────────────────────────────────────────────────────────┘     │     │
│        │                                                              │     │
│        │  gatherContext(ctx, workDir)                                 │     │
│        │                                                              │     │
│        ▼                                                              │     │
│   ┌──────────────────────┐    ┌──────────────────────┐                │     │
│   │ FilesystemProvider   │    │    GitProvider       │                │     │
│   │                      │    │                      │                │     │
│   │ • Lee archivos .go,  │    │ • git branch         │                │     │
│   │   .js, .py, etc.     │    │ • git log -5         │                │     │
│   │ • Ignora node_modules│    │ • git status         │                │     │
│   │ • Máx 30 archivos    │    │                      │                │     │
│   │ • Máx 200KB total    │    │                      │                │     │
│   └──────────┬───────────┘    └──────────┬───────────┘                │     │
│              │                           │                            │     │
│              └─────────────┬─────────────┘                            │     │
│                            │                                          │     │
│                            ▼                                          │     │
│              ┌─────────────────────────────┐                          │     │
│              │    []ContextResult          │                          │     │
│              │                             │                          │     │
│              │ • Provider: "filesystem"    │                          │     │
│              │   Content: [código...]      │                          │     │
│              │                             │                          │     │
│              │ • Provider: "git"           │                          │     │
│              │   Content: [info git...]    │                          │     │
│              └──────────────┬──────────────┘                          │     │
│                             │                                         │     │
│                             ▼                                         │     │
│   ┌─────────────────────────────────────────────────────────────┐     │     │
│   │              FASE 2: CONSTRUCCIÓN DEL PROMPT                │     │     │
│   └─────────────────────────────────────────────────────────────┘     │     │
│                             │                                         │     │
│                             ▼                                         │     │
│              ┌─────────────────────────────┐                          │     │
│              │    builder.Build()          │                          │     │
│              │                             │                          │     │
│              │ INPUT:                      │                          │     │
│              │ • contexts []ContextResult  │                          │     │
│              │ • task (pregunta usuario)   │                          │     │
│              │                             │                          │     │
│              │ OUTPUT:                     │                          │     │
│              │ • systemPrompt              │                          │     │
│              │ • userPrompt                │                          │     │
│              └──────────────┬──────────────┘                          │     │
│                             │                                         │     │
│                             ▼                                         │     │
│   ┌─────────────────────────────────────────────────────────────┐     │     │
│   │              FASE 3: GENERACIÓN DE RESPUESTA                │     │     │
│   └─────────────────────────────────────────────────────────────┘     │     │
│                             │                                         │     │
│                             ▼                                         │     │
│              ┌─────────────────────────────┐                          │     │
│              │    client.Generate()        │                          │     │
│              │                             │                          │     │
│              │ • HTTP POST a Ollama        │                          │     │
│              │ • Streaming NDJSON          │                          │     │
│              │ • Callback por cada chunk   │                          │     │
│              └──────────────┬──────────────┘                          │     │
│                             │                                         │     │
│                             ▼                                         │     │
│   ┌─────────────────────────────────────────────────────────────┐     │     │
│   │              FASE 4: POST-PROCESAMIENTO                     │     │     │
│   └─────────────────────────────────────────────────────────────┘     │     │
│                             │                                         │     │
│                             ▼                                         │     │
│              ┌─────────────────────────────┐                          │     │
│              │ offerToSaveCodeBlocks()     │                          │     │
│              │                             │                          │     │
│              │ • Detecta bloques ```       │                          │     │
│              │ • Extrae nombre de archivo  │                          │     │
│              │ • Pregunta si guardar       │                          │     │
│              │ • Escribe archivo           │                          │     │
│              └──────────────┬──────────────┘                          │     │
│                             │                                         │     │
└─────────────────────────────┼───────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              USUARIO                                        │
│                         (ve la respuesta)                                   │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Flujo de Datos del Contexto

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         DIRECTORIO DE TRABAJO                               │
│                              /mi-proyecto                                   │
└─────────────────────────────────┬───────────────────────────────────────────┘
                                  │
                ┌─────────────────┴─────────────────┐
                │                                   │
                ▼                                   ▼
┌───────────────────────────────┐   ┌───────────────────────────────┐
│     FILESYSTEM PROVIDER       │   │        GIT PROVIDER           │
├───────────────────────────────┤   ├───────────────────────────────┤
│                               │   │                               │
│  filepath.WalkDir()           │   │  exec.Command("git", ...)     │
│         │                     │   │         │                     │
│         ▼                     │   │         ▼                     │
│  ┌─────────────────────┐      │   │  ┌─────────────────────┐      │
│  │ Filtros aplicados:  │      │   │  │ Comandos:           │      │
│  │                     │      │   │  │                     │      │
│  │ ✗ node_modules/     │      │   │  │ • rev-parse --git-dir│     │
│  │ ✗ vendor/           │      │   │  │ • branch --show-current   │
│  │ ✗ .git/             │      │   │  │ • log --oneline -5  │      │
│  │ ✗ dist/             │      │   │  │ • status --short    │      │
│  │ ✗ __pycache__/      │      │   │  └─────────────────────┘      │
│  │ ✗ *.lock            │      │   │                               │
│  │ ✗ archivos > 50KB   │      │   │                               │
│  │                     │      │   │                               │
│  │ ✓ *.go, *.js, *.py  │      │   │                               │
│  │ ✓ *.json, *.yaml    │      │   │                               │
│  │ ✓ Makefile, etc.    │      │   │                               │
│  └─────────────────────┘      │   │                               │
│         │                     │   │         │                     │
│         ▼                     │   │         ▼                     │
│  ┌─────────────────────┐      │   │  ┌─────────────────────┐      │
│  │ os.ReadFile()       │      │   │  │ Parsear output      │      │
│  │ (lee contenido)     │      │   │  │                     │      │
│  └─────────────────────┘      │   │  └─────────────────────┘      │
│         │                     │   │         │                     │
└─────────┼─────────────────────┘   └─────────┼─────────────────────┘
          │                                   │
          ▼                                   ▼
┌───────────────────────────────┐   ┌───────────────────────────────┐
│      ContextResult            │   │      ContextResult            │
├───────────────────────────────┤   ├───────────────────────────────┤
│ Provider: "filesystem"        │   │ Provider: "git"               │
│ Content:                      │   │ Content:                      │
│ """                           │   │ """                           │
│ ## Contenido de archivos      │   │ Branch: main                  │
│                               │   │                               │
│ ### main.go                   │   │ Recent commits:               │
│ ```                           │   │ abc123 Add feature            │
│ package main                  │   │ def456 Fix bug                │
│ ...                           │   │                               │
│ ```                           │   │ Changed files:                │
│                               │   │ M  app.go                     │
│ ### config.go                 │   │ """                           │
│ ```                           │   │                               │
│ package config                │   │                               │
│ ...                           │   │                               │
│ ```                           │   │                               │
│ """                           │   │                               │
└───────────────┬───────────────┘   └───────────────┬───────────────┘
                │                                   │
                └─────────────────┬─────────────────┘
                                  │
                                  ▼
                    ┌─────────────────────────────┐
                    │     []ContextResult         │
                    │     (array combinado)       │
                    └─────────────────────────────┘
```

---

## 3. Flujo de Construcción del Prompt

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           BUILDER.BUILD()                                   │
└─────────────────────────────────────────────────────────────────────────────┘

ENTRADAS:
─────────

┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐
│   SystemPrompt      │  │   []ContextResult   │  │      Task           │
│   (config.go)       │  │   (providers)       │  │   (usuario)         │
├─────────────────────┤  ├─────────────────────┤  ├─────────────────────┤
│ "Eres un asistente  │  │ [{filesystem, ...}  │  │ "explica el         │
│  de programación    │  │  {git, ...}]        │  │  archivo main.go"   │
│  experto..."        │  │                     │  │                     │
└──────────┬──────────┘  └──────────┬──────────┘  └──────────┬──────────┘
           │                        │                        │
           │                        │                        │
           ▼                        ▼                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              PROCESO                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   1. system = config.SystemPrompt                                           │
│                                                                             │
│   2. Para cada context en contexts:                                         │
│      └─► Agregar "## Context: {provider}\n{content}"                        │
│                                                                             │
│   3. Agregar "## Task\n{task}"                                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

SALIDAS:
────────

┌─────────────────────────────────────────────────────────────────────────────┐
│                           SYSTEM PROMPT                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Eres un asistente de programación experto. Analizas código y das          │
│   sugerencias.                                                              │
│                                                                             │
│   REGLAS:                                                                   │
│   - Cuando crees o modifiques archivos, usa este formato...                 │
│   - Siempre muestra el contenido completo del archivo.                      │
│   - Cuando sugieras comandos, explica qué hacen.                            │
│                                                                             │
│   Sé conciso. Enfócate en la tarea específica del usuario.                  │
│   Responde en español.                                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                            USER PROMPT                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ## Context: filesystem                                                    │
│   ## Contenido de archivos del proyecto                                     │
│                                                                             │
│   ### main.go                                                               │
│   ```                                                                       │
│   package main                                                              │
│   import "fmt"                                                              │
│   func main() { fmt.Println("Hello") }                                      │
│   ```                                                                       │
│                                                                             │
│   ### config.go                                                             │
│   ```                                                                       │
│   package config                                                            │
│   var Model = "qwen2.5-coder:14b"                                           │
│   ```                                                                       │
│                                                                             │
│   ## Context: git                                                           │
│   Branch: main                                                              │
│   Recent commits:                                                           │
│   abc123 Initial commit                                                     │
│                                                                             │
│   ## Task                                                                   │
│   explica el archivo main.go                                                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Flujo de Comunicación con Ollama

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            OLI (cliente)                                    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ HTTP POST
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                     REQUEST a /api/generate                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   POST http://localhost:11434/api/generate                                  │
│   Content-Type: application/json                                            │
│                                                                             │
│   {                                                                         │
│     "model": "qwen2.5-coder:14b",                                           │
│     "system": "Eres un asistente de programación...",                       │
│     "prompt": "## Context: filesystem\n...\n## Task\nexplica...",           │
│     "stream": true                                                          │
│   }                                                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         OLLAMA SERVER                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                    MODELO LLM                                       │   │
│   │                qwen2.5-coder:14b                                    │   │
│   │                                                                     │   │
│   │   • Procesa system prompt                                           │   │
│   │   • Procesa contexto (código del proyecto)                          │   │
│   │   • Procesa tarea del usuario                                       │   │
│   │   • Genera respuesta token por token                                │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ NDJSON Stream
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                     RESPONSE (streaming)                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   {"response": "El", "done": false}                                         │
│   {"response": " archivo", "done": false}                                   │
│   {"response": " main", "done": false}                                      │
│   {"response": ".go", "done": false}                                        │
│   {"response": " contiene", "done": false}                                  │
│   ...                                                                       │
│   {"response": "", "done": true}                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ Por cada chunk
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            OLI (callback)                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   func(chunk string) {                                                      │
│       fmt.Print(chunk)           // Mostrar al usuario                      │
│       fullResponse.WriteString(chunk)  // Acumular para post-proceso        │
│   }                                                                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
                              ┌───────────────┐
                              │   TERMINAL    │
                              │   (stdout)    │
                              │               │
                              │ El archivo    │
                              │ main.go       │
                              │ contiene...   │
                              └───────────────┘
```

---

## 5. Flujo de Guardado de Archivos

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      RESPUESTA DEL MODELO                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Aquí tienes el código:                                                    │
│                                                                             │
│   **hello.go**                                                              │
│   ```go                                                                     │
│   package main                                                              │
│                                                                             │
│   import "fmt"                                                              │
│                                                                             │
│   func main() {                                                             │
│       fmt.Println("Hello, World!")                                          │
│   }                                                                         │
│   ```                                                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ offerToSaveCodeBlocks()
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      DETECCIÓN DE PATRONES                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Patrones buscados (regex):                                                │
│                                                                             │
│   1. ```lang:filename.ext                                                   │
│   2. ```lang filename.ext                                                   │
│   3. **filename.ext** seguido de ```                                        │
│   4. `filename.ext`: seguido de ```                                         │
│   5. Archivo: filename.ext seguido de ```                                   │
│                                                                             │
│   Match encontrado:                                                         │
│   • Archivo: "hello.go"                                                     │
│   • Contenido: "package main\nimport \"fmt\"..."                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      CONFIRMACIÓN DEL USUARIO                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Terminal:                                                                 │
│   ─────────                                                                 │
│    Código detectado para: hello.go                                          │
│    ¿Guardar archivo 'hello.go'? (s/n): _                                    │
│                                                                             │
│   Usuario escribe: s                                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      │ Si confirma
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                      ESCRITURA DEL ARCHIVO                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   tools.WriteFileDirectly("hello.go", content)                              │
│                                                                             │
│   1. Resolver ruta absoluta                                                 │
│   2. Crear directorios si no existen (MkdirAll)                             │
│   3. Escribir archivo (WriteFile)                                           │
│                                                                             │
│   Terminal:                                                                 │
│   ─────────                                                                 │
│    Guardado: hello.go                                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Flujo del Modo Interactivo

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              $ oli                                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         INICIALIZACIÓN                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   1. Cargar configuración (config.go)                                       │
│   2. Crear App con providers                                                │
│   3. Mostrar banner:                                                        │
│                                                                             │
│      oli (qwen2.5-coder:14b)                                               │
│      Comandos: help | repos | repo <nombre> | ls | read | write | salir    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
                         ┌────────────────────────┐
                         │    LOOP PRINCIPAL      │◄─────────────────────┐
                         └────────────┬───────────┘                      │
                                      │                                  │
                                      ▼                                  │
                         ┌────────────────────────┐                      │
                         │   Mostrar prompt ">"   │                      │
                         └────────────┬───────────┘                      │
                                      │                                  │
                                      ▼                                  │
                         ┌────────────────────────┐                      │
                         │   Leer input usuario   │                      │
                         │   scanner.Scan()       │                      │
                         └────────────┬───────────┘                      │
                                      │                                  │
                                      ▼                                  │
                         ┌────────────────────────┐                      │
                         │   ¿Comando especial?   │                      │
                         └────────────┬───────────┘                      │
                                      │                                  │
                    ┌─────────────────┼─────────────────┐                │
                    │                 │                 │                │
                    ▼                 ▼                 ▼                │
             ┌────────────┐    ┌────────────┐    ┌────────────┐          │
             │   salir    │    │ ls/read/   │    │  Pregunta  │          │
             │            │    │ write/etc  │    │  al modelo │          │
             └─────┬──────┘    └─────┬──────┘    └─────┬──────┘          │
                   │                 │                 │                 │
                   ▼                 │                 │                 │
             ┌────────────┐          │                 │                 │
             │   EXIT     │          │                 │                 │
             └────────────┘          │                 │                 │
                                     │                 │                 │
                                     ▼                 ▼                 │
                              ┌────────────┐    ┌────────────┐           │
                              │  Ejecutar  │    │  app.Run() │           │
                              │  comando   │    │            │           │
                              └─────┬──────┘    └─────┬──────┘           │
                                    │                 │                  │
                                    └────────┬────────┘                  │
                                             │                           │
                                             └───────────────────────────┘
```
